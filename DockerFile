# === Builder (Chainguard) ===
FROM cgr.dev/chainguard/python:latest-dev AS builder
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1 PIP_NO_CACHE_DIR=1

# växla till root i builder så vi får skriva i /usr/local
USER root

# kopiera in krav
COPY requirements.txt .

# skapa EN venv och lägg den i PATH
ENV VENV=/usr/local/venv
RUN python -m venv "$VENV"
ENV PATH="$VENV/bin:$PATH"

# installera beroenden
RUN pip install --upgrade pip \
 && pip install -r requirements.txt

# kopiera in appen
COPY app app
COPY db db
COPY scripts scripts
COPY alembic.ini alembic.ini

# === Runtime (distroless) ===
FROM gcr.io/distroless/python3-debian12
WORKDIR /app
ENV PYTHONUNBUFFERED=1 PYTHONDONTWRITEBYTECODE=1 PYTHONPATH=/app

# ta med venv + kod från builder
COPY --from=builder /usr/local/venv /usr/local/venv
COPY --from=builder /app /app

# kör som nonroot i runtime
USER 65532:65532
EXPOSE 8000

# kör med absolut sökväg till python i venv: säkrast i distroless
ENTRYPOINT ["/usr/local/venv/bin/python","-m","uvicorn","app.main:app","--host","0.0.0.0","--port","8000"]
